# LUNA16 Lung Nodule Segmentation with 3D U-Net

Production-ready –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏) —É–∑–µ–ª–∫–æ–≤ –≤ –ö–¢-—Å–Ω–∏–º–∫–∞—Ö –ª—ë–≥–∫–∏—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º 3D U-Net –Ω–∞ –¥–∞—Ç–∞—Å–µ—Ç–µ LUNA16.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –≥–ª—É–±–æ–∫–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ –∑–∞–¥–∞—á—É voxel-wise —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ —É–∑–µ–ª–∫–æ–≤ –ª—ë–≥–∫–∏—Ö:

- **–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞**: –∑–∞–≥—Ä—É–∑–∫–∞ .mhd/.raw —Ñ–∞–π–ª–æ–≤, —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥ –∫ spacing 1x1x1 –º–º, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è HU, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫ 256√ó256√ó64
- **–ê—É–≥–º–µ–Ω—Ç–∞—Ü–∏–∏**: –≤—Ä–∞—â–µ–Ω–∏—è, –æ—Ç—Ä–∞–∂–µ–Ω–∏—è, —à—É–º, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏, –∞—Ñ—Ñ–∏–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
- **–ú–æ–¥–µ–ª—å**: 3D U-Net —Å batch normalization, PReLU –∞–∫—Ç–∏–≤–∞—Ü–∏—è–º–∏
- **–û–±—É—á–µ–Ω–∏–µ**: Dice + BCE loss, AdamW –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä, Cosine Annealing LR scheduler, mixed precision training
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ø–æ–¥—Ä–æ–±–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (Dice, Sensitivity, Precision, Recall)
- **–ò–Ω—Ñ–µ—Ä–µ–Ω—Å**: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –º–∞—Å–æ–∫, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —É–∑–µ–ª–∫–æ–≤, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
luna16_segmentation/
‚îú‚îÄ‚îÄ README.md                  # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ requirements.txt           # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ utils.py                   # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ preprocess.py              # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ dataset.py                 # PyTorch Dataset
‚îú‚îÄ‚îÄ model.py                   # 3D U-Net –º–æ–¥–µ–ª—å
‚îú‚îÄ‚îÄ train.py                   # –°–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ validate.py                # –°–∫—Ä–∏–ø—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ infer.py                   # –°–∫—Ä–∏–ø—Ç –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞
‚îî‚îÄ‚îÄ data/
    ‚îî‚îÄ‚îÄ LUNA16/
        ‚îú‚îÄ‚îÄ raw/               # –ò—Å—Ö–æ–¥–Ω—ã–µ .mhd/.raw —Ñ–∞–π–ª—ã
        ‚îú‚îÄ‚îÄ annotations.csv    # –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —É–∑–µ–ª–∫–æ–≤
        ‚îú‚îÄ‚îÄ seg-lungs-LUNA16/  # –ú–∞—Å–∫–∏ –ª—ë–≥–∫–∏—Ö
        ‚îî‚îÄ‚îÄ processed/         # –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –° –ø–æ–º–æ—â—å—é conda (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
conda create -n luna16 python=3.10
conda activate luna16

# –ò–ª–∏ —Å –ø–æ–º–æ—â—å—é venv
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PyTorch (–≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é –¥–ª—è –≤–∞—à–µ–π CUDA)
# –î–ª—è CUDA 11.8:
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# –î–ª—è CUDA 12.1:
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# –î–ª—è CPU:
pip install torch torchvision torchaudio

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt
```

## üìä –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞ LUNA16

–°–∫–∞—á–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã —Å [LUNA16 –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞](https://luna16.grand-challenge.org/Download/):

- **–°—É–±—Å–µ—Ç—ã 0-9**: —Ñ–∞–π–ª—ã .mhd/.raw —Å –ö–¢-—Å–Ω–∏–º–∫–∞–º–∏
- **annotations.csv**: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –¥–∏–∞–º–µ—Ç—Ä—ã —É–∑–µ–ª–∫–æ–≤
- **seg-lungs-LUNA16.zip**: –º–∞—Å–∫–∏ –ª—ë–≥–∫–∏—Ö

### 2. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª—ã —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```
data/LUNA16/
‚îú‚îÄ‚îÄ raw/
‚îÇ   ‚îú‚îÄ‚îÄ 1.3.6.1.4.1.14519.5.2.1.6279.6001.*.mhd
‚îÇ   ‚îú‚îÄ‚îÄ 1.3.6.1.4.1.14519.5.2.1.6279.6001.*.raw
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ annotations.csv
‚îî‚îÄ‚îÄ seg-lungs-LUNA16/
    ‚îú‚îÄ‚îÄ 1.3.6.1.4.1.14519.5.2.1.6279.6001.*.mhd
    ‚îî‚îÄ‚îÄ ...
```

### 3. –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏:

```bash
python preprocess.py
```

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `preprocess.py`):
- **target_spacing**: (1.0, 1.0, 1.0) –º–º
- **target_size**: (64, 256, 256) –≤–æ–∫—Å–µ–ª–µ–π (z, y, x)
- **HU range**: [-1000, 400]

–†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ `data/LUNA16/processed/`

**‚ö†Ô∏è –í–∞–∂–Ω–æ**: –ü–æ—Å–ª–µ —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.

## üöÄ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

### –ë–∞–∑–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ

```bash
python train.py
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è (–≤ `train.py`):

```python
trainer = Trainer(
    data_dir='data/LUNA16/processed',
    output_dir='experiments/luna16_unet',
    num_epochs=100,              # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö
    batch_size=2,                # –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç GPU –ø–∞–º—è—Ç–∏)
    learning_rate=1e-4,          # Learning rate
    weight_decay=1e-5,           # Weight decay –¥–ª—è AdamW
    num_workers=4,               # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ workers –¥–ª—è DataLoader
    device='cuda',               # 'cuda' –∏–ª–∏ 'cpu'
    mixed_precision=True,        # Mixed precision training
    checkpoint_interval=5        # –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤
)
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—É—á–µ–Ω–∏—è

```bash
# –ó–∞–ø—É—Å–∫ TensorBoard
tensorboard --logdir experiments/luna16_unet/logs_*
```

–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost:6006

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è

–°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `experiments/luna16_unet/`:
- `checkpoints/best_model.pth` - –ª—É—á—à–∞—è –º–æ–¥–µ–ª—å
- `checkpoints/checkpoint_epoch_*.pth` - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —á–µ–∫–ø–æ–∏–Ω—Ç—ã
- `logs_*/` - –ª–æ–≥–∏ –¥–ª—è TensorBoard

## üìà –í–∞–ª–∏–¥–∞—Ü–∏—è

–ü–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é:

```bash
python validate.py
```

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- `validation_results.csv` - –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞
- `metrics_distribution.png` - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ (mean ¬± std –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫)

## üîÆ –ò–Ω—Ñ–µ—Ä–µ–Ω—Å

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –Ω–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

```bash
python infer.py
```

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `experiments/luna16_unet/inference/`:
- `predicted_masks/` - –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –º–∞—Å–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ .npy
- `visualizations/` - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π (—Å—Ä–µ–∑—ã —Å –Ω–∞–ª–æ–∂–µ–Ω–∏–µ–º)
- `*_nodules.npy` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —É–∑–µ–ª–∫–æ–≤
- `inference_summary.npy` - —Å–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –§–æ—Ä–º–∞—Ç –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö